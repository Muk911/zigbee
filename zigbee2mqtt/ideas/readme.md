Набросок текста, который я начал писать по теме конвертеров для ПО координаторов.

Одной из часто встречающихся задач, решаемых при построении систем Умного дома, да и любых систем сбора данных и управления (например систем SCADA), является отображение (маппинг) объектных моделей, 
используемых различными частями системы для представления данных и команд управления.
Примерами таких моделей являются:
- структуры MIB в протоколе  SNMP;
- профиль GATT протокола Bluetooth;
- кластеры ZCL протокола zigbee;
- регистры Modbus.

Каждое ПО умного дома или SCADA реализует свою модель представления данных. Например, для Home Assistant это модель Entities architecture, описанная в документации HA:
https://developers.home-assistant.io/docs/architecture/devices-and-services

Отдельной моделью данных можно считать способ представления значений атрибутов на экранных формах ПО. Хотя с точки зрения логики управления нет разницы, как реализовано поле для просмотра и 
изменения целочисленного атрибута (ручной ввод, ползунок, круговой ползунок), но от этого зависит удобство пользователя. Поэтому в ПО обычно реализуются возможности настройки внешнего вида визуальных 
элементов в тех или иных границах.

Отдельно встаёт вопрос объединения элементарных сущностей модели в сущности более высокого порядка - например группировка параметров, измеряемых одним датчиком.
Некоторые модели данных вообще не предусматривают такое объединение, другие модели (та же модель кластеров Zigbee Cluster Library) изначально рассчитаны на такое логическое объединение.
Возможность объединения сущностей модели данных особенно важно для устройств, предусматривающих стандартные способы управления ими - термостаты, умные лампы и др.

Отображение модели данных ZCL в системах УД

У каждого разработчика ПО шлюза Zigbee для систем УД встаёт проблема отображения модели Zigbee Cluster Library (ZCL) в модель данных ПО умного дома.
На сегодня существует несколько популярных систем УД, что затрудняет реализацию универсального механизма такого отображения. Поэтому разработчики идут двумя основными путями: 
1) реализация узкоспециализированных решений для одного ПО УД,
например ZHA для Home Assistant или Zigbee2Tasmota.
2) использование брокера сообщений MQTT для реализации промежуточной модели данных с топиках брокера, которая далее может быть подключена к системам УД конфигурированием со стороны ПО УД. Так работают Zigbee2Mqtt, SLS Gateway, HOMEd.
Каждый из этих способов имеет свои плюсы и минусы, но если рассматривать универсальную реализацию, то предпочтительнее использовать промежуточную модель данных, которую уже знают популярные системы УД.

Особенности использования модели данных ZCL

Модель данных Zigbee Cluster Library для профиля бытовых устройств (Home Automation) содержит большое количество стандартных кластеров и их атрибутов. Одновременно с этим 
ZCL позволяет определять нестандартные кластеры, состав атрибутов и команд в которых разработчик выбирает сам.
Картину усложняет подход китайских производителей экосистемы Tuya, в которой кластеры ZCL используются формально для передачи команд, реализующих собственную модель данных, основанную на Data Points. 
Скорее всего это сделано для унификации с аналогичными WiFi версиями этих устройств.
Остальные производители стараются использовать стандартные кластеры ZCL, но при наличии у устройств каких то специфичных функций, вынуждены добавлять кастомные кластеры, требующие  конфигурирование или 
написание кода для конвертации  данных и команд этих кластеров в модель данных ПО УД.

Общие вопросы реализации отображения модели данных ZCL в ПО УД

Опыт показывает, что поддержка популярных устройств Zigbee в ПО умного дома невозможна без написания кода. В некоторых ПО, например TasmotaZigbee и HOMEd, сделана попытка обойтись только файлами конфигурации, 
но по факту в ядре этих систем сделана обработка кодом для известных кастомных кластеров (в частности Tuya).

Во внешних конвертерах Zigbee2Mqtt и квирках ZHA такие кластеры обрабатываются явным образом, что позволяет при наличии достаточной мотивации самостоятельно реализовать в таком ПО поддержку любого 
неподдерживаемого устройства, не дожидаясь новых обновлений ядра ПО.
Далее будем использовать термин "конвертер", имея в виду любые варианты преобразования моделей данных с использованием кода. 

При отображении моделей данных возникают следующие сложности:
1) Соответствие между сущностями ПО УД и атрибутами ZCL, отличное от "один-к-одному". Чаще всего необходимо реализовать упаковку нескольких значений одной модели в единственный атрибут другой модели.
2) Ограничения со стороны устройств допустимых значений атрибутов. Передача недопустимых значений приводит к ошибкам. Необходимо определить ограничения на диапазон значений, чтобы пользовательский интерфейс ПО
3) умного дома обеспечил ввод только допустимых значений.
4) Логически связанные сущности модели данных, доступность которых зависит от значений других сущностей.

Exposes

Если для "прямых" решений, например Zigbee Home Automation (ZHA) непосредственно используется модель данных Home Automation, для решений с использованием MQTT необходимы некие абстрактные элементы, которые 
будут "изображать" сущности модели данных ПО УД. В Zigbee2Mqtt такие сущности названы exposes. Для краткости будем использовать этот термин.
Expose может соответствовать:
- единичному атрибуту;
- устойчивому комплексу атрибутов и команд, например термостату;
- группе элементов.
Имеет смысл предопределить стандартные, шаблонные exposes, которые встречаются наиболее часто, и реализовать возможность определять нестандартные exposes.

Expose для единичного атрибута должен определять:
- идентификатор атрибута-источника ZCL;
- наименование атрибута в ПО УД;
- тип данных;
- возможность изменения значения атрибута;
- допустимые значения, для чисел это диапазон, точность и шаг изменения, для перечислимого типа - список значений;
- номер конечной точки Zigbee, если устройство поддерживает разные конечные точки;
- опциально: описание атрибута.

На основе спецификации exposes генерируются топики HA Mqtt Discovery, что позволит HA автоматически добавить объекты устройств в свою модель данных и настроить адресацию данных и команд на топики значений этих exposes.

Кроме exposes конвертер устройства содержит список методов, выполняющих преобразование данных пакетов ZCL в значения exposes и обратно. В Zigbee2Mqtt это реализовано через промежуточное представление пакетов ZCL 
в формате JSON. 


Fingerprinting

Для назначения устройству правильного конвертера (стандартного или внешнего) требуется найти нужный конвертер в базе конвертеров по данным, полученным от устройства во время интервью с координатором. 
Проблема не решается только использованием идентификатора модели устройства. Китайские производители любят выпускать устройства с новым идентификатором без изменения кластеров и атрибутов устройства. 
С другой стороны, одна и та же модель может выпускаться с разным количеством конечных точек.
Поэтому применяется принцип fingerprinting ("снятие отпечатков пальцев"), когда для идентификации конкретной модели устройства выделяется уникальный набор признаков. Чаще всего в этот набор входят производитель 
и модель производителя, но встречаются совсем нетривиальные "отпечатки".

Автоопределение устройств

Если для устройства не было найдено соответствие fingerprint в базе данных устройств, возникает дилемма - выдать ошибку и даже не пытаться подключать устройство, или выдать предупреждение и попытаться подобрать 
наиболее подходящий конвертер.
В случае наличия в устройстве только стандартных кластеров ZCL и соблюдения стандартов со стороны производителя, конвертер может быть автоматически собран из базовых частей по списку кластеров. 
Если устройство использует нестандартные кластеры или производитель не соблюдает стандарты, остаётся только надеяться на проверку подобранного/сгенерированого конвертера в реальных условиях.

В некоторых решениях zigbee- шлюза имеется возможность выбрать конвертер устройства вручную из базы данных устройств. Это удобно в тех случаях, когда известен поддерживаемый аналог устройства, 
имеющего другой fingerprint.


Универсальные конвертеры

Постулаты:
0. Exposes используются.
1. Конвертер как совокупность exposes и других настроек имеет смысл для обеспечения оптимальной работы устройства.
2. Fingerprinting поддерживается.
3. Реализуется ручное назначение конвертера для устройства, как в SLS. Для этого нужна уникальная идентификация конвертера, например uuid.
4. Реализуется автосборка конвертера из отдельных частей на основе кластеров устройства или мета-правил.
