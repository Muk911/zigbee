# Обновления Zigbee2MQTT
Крупные обновления Zigbee2MQTT приводят к несовместимости некоторых его частей и необходимости выполнять ручные настройки. В этой статье я попытаюсь дополнить официальные документы своим пониманием сути произошедших изменений.

## Обновление на v2.0.0

### Переход от сенсоров action к событиям
Zigbee2MQTT версий ранее 2.0.0 для устройств, имеющих кнопки звонкового типа (не сохраняющих свое состояние), публиковал в Home Assistant Discovery сенсоры sensor.имяустройства_action, меняющие свое значение при нажатии на одну из кнопок устройства. Например, при одиночном нажатии на первую кнопку такой сенсор получал значение "1_single", при двойном нажатии на вторую кнопку - "2_double" и т.д. Поскольку физически кнопки звонкового типа не имеют состояния, значение таких сенсоров должно сразу же сбрасываться.
Home Assistant считывал информацию Discovery и создавал у себя соответствующие устройства и объекты.
При создании автоматизации, срабатывающей на нажатие кнопки устройства, необходимо было выбрать тип триггера "Состояние", выбрать объект сенсора _action и указать значение сенсора, на которое должна срабатывать автоматизация.
Такой подход при своей простоте имеет архитектурный недостаток - значения action-сенсоров сохраняются в истории как изменения значения сенсора.

В версии Zigbee2MQTT произошли изменения в реализации action. Теперь вместо сенсоров используется событие event.имяустройства_action. 
Событие не имеет значения. Триггер автоматизации, настроенный на событие, срабатывает при нажатии любой кнопки на устройстве. Для определения, нажатие какой кнопки вызвало событие, необходимо добавить в автоматизацию проверку значения атрибута event_type триггера через условие Шаблон (пример шаблона: {{trigger.to_state.attributes.event_type == '1_single'}}).

С практической точки зрения, при переходе на Zigbee2MQTT v2.0.0 необходимо доработать все автоматизации, где в триггерах используются объекты вида sensor.*_action.
Для начала рекомендуется открыть в редакторе файл automations.yaml и составить список таких автоматизаций. Исходное содержимое файла лучше сохранить в виде резервной копии.
Дальше возможны два варианта:
1. При наличии в списке на доработку нескольких автоматизаций для одного устройства можно исправить каждую из этих автоматизаций. В автоматизации будут добавлены условия выполнения действий в зависимости от атрибута event_type триггера. Тогда при возникновении события от устройства (нажатии на кнопку) будут срабатывать все автоматизации этого устройства, но только у одной автоматизации будут выполняться действия.
2. Создать единственную автоматизацию для каждого из устройств. В триггере автоматизации будет указана сущность event.имяустройства_action, а в действиях будет добавлен блок Выбор. Каждый вариант блока выбора содержит условие проверки атрибута event_type триггера и действия, которые должны быть выполнены при выполнении условия. Именно такой вариант описывается в официальной документации.

Первый вариант менее трудоемкий, изменения легко выполнить в GUI. Второй вариант удобнее выполнять редактированием файла automations.yaml, особенно в случае большого количества действий в автоматизации.
